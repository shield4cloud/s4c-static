let companysList; window.addEventListener('load', (event) => { const session = getCookie("pSession"); loadCompany(session); document.getElementById("back") .onclick = function() { window.location.reload(); }; document.getElementById("wafAdd") .onclick = function() { Swal.fire({ title: 'Création du WAF', html: 'Domaine: <input type="text" id="newHost"> <br> Entreprise: <select id="companySelect"></select>', showCloseButton: false, showCancelButton: false, focusConfirm: false, confirmButtonText: 'Créer ce waf' }).then((result) => { if (result.isConfirmed) { const wafRequestCreate=new XMLHttpRequest(); wafRequestCreate.onload = () => { const status = wafRequestCreate.status; if (status == 202) { alertSuccess("Le waf à bien été créer"); setTimeout(function(){ window.location.reload(); },3000); } else { hasError(wafRequestCreate); } }; const json = { "host": document.getElementById("newHost").value}; wafRequestCreate.open('PUT', 'https://api.shield4cloud.com/dashboard/wafs/create/'); wafRequestCreate.setRequestHeader('X-Token', session); wafRequestCreate.setRequestHeader('X-Company', document.getElementById("companySelect").value); wafRequestCreate.send(JSON.stringify(json)); } }); for (var i = 0; i < companysList.length; i++) { var company=companysList[i]; var opt=document.createElement('option'); opt.value = company["uniqueId"]; opt.innerHTML = company["name"]; document.getElementById("companySelect").appendChild(opt); } }; }); function createWaf(session, uuidWaf, uuidCompany) { document.getElementById(uuidWaf) .onclick = function() { loadWaf(session, uuidCompany, uuidWaf); document.getElementById("wafRemove") .onclick = function() { const wafRequestRemove=new XMLHttpRequest(); wafRequestRemove.onload = () => { const status=wafRequestRemove.status; if (status == 202) { alertSuccess("Le waf à bien été supprimer"); setTimeout(function(){ window.location.reload(); },3000); } else { hasError(wafRequestRemove); } }; wafRequestRemove.open('DELETE', 'https://api.shield4cloud.com/dashboard/wafs/delete/' + uuidWaf); wafRequestRemove.setRequestHeader('Content-Type', "application/json"); wafRequestRemove.setRequestHeader('X-Token', session); wafRequestRemove.setRequestHeader('X-Company', uuidCompany); wafRequestRemove.send(); } }; } function hasError(request) { if (request.status == 200 || request.status == 400) { const errorResult=JSON.parse(request.responseText); if (errorResult.error == "Empty Company" || errorResult.error == "Company is remove") { alertError("Vous n'avez pas d'entreprise !"); } if (errorResult.error == "Bad Host") { alertError("Votre domaine est incorrect !"); } if (errorResult.error == "Bad ServerAddress") { alertError("L'addresse du serveur est incorrect !"); } if (errorResult.error == "Bad Certificat") { alertError("Votre certificat est invalide (Public key & Private key)"); } if (errorResult.error == "Bad APIDirectory") { alertError("Votre api addresse est invalide (Exemple: /api/v1/)"); } if (errorResult.error == "No Authorized") { alertError("Vous ne pouvez pas accédez à cette élément !"); } if (errorResult.error == "Waf unknown") { alertError("Vous ne pouvez pas accédez à cette élément !"); } if (errorResult.error == "User is unknown") { noSafeLogin(); } if (errorResult.error == "Bad Information") { noSafeLogin(); } } } function alertError(text) { Swal.fire({ icon: 'error', title: 'Oops...', text: text, showConfirmButton: true, timer: 5000 }); }; function alertSuccess(text) { Swal.fire({ icon: 'success', title: 'Good Job!', text: text, showConfirmButton: true, timer: 5000 }); }; function loadCompany(session) { const companyRequest=new XMLHttpRequest(); companyRequest.onload = () => { const status = companyRequest.status; if (status == 202) { const companyListResult = JSON.parse(companyRequest.responseText); const companyNumber = companyListResult.length; companysList = companyListResult; for (var i = 0; i < companyListResult.length; i++) { var company=companyListResult[i]; loadWafs(session, company, companyNumber); } } else { hasError(companyRequest); } }; companyRequest.open('GET', 'https://api.shield4cloud.com/dashboard/companys/' + session); companyRequest.setRequestHeader('Content-Type', 'application/json'); companyRequest.send(); } function loadWafs(session, company, companyNumber) { const wafsRequest=new XMLHttpRequest(); wafsRequest.onload = () => { const status = wafsRequest.status; if (wafsRequest.status == 202) { const wafListResult = JSON.parse(wafsRequest.responseText); const wafNumber = wafListResult.length; document.getElementById('wafCount').textContent = wafNumber; for (var i = 0; i < wafListResult.length; i++) { var wafs=wafListResult[i]; var divCardLg=document.createElement("div"); divCardLg.className = "card-lg"; var divCardLeft=document.createElement("div"); divCardLeft.className = "left"; var imgLeft=document.createElement("img"); if(company["logo"] == null) { imgLeft.src = "https://logos-marques.com/wp-content/uploads/2021/03/Apple-logo-500x333.png"; } else { imgLeft.src = company["logo"]; } var divCardRight=document.createElement("div"); divCardRight.className = "right"; var spanRight=document.createElement("span"); spanRight.innerText = wafs["host"]; var aCard=document.createElement("a"); aCard.innerText = "Pour " + company["name"]; aCard.id = wafs["uniqueId"]; divCardLeft.appendChild(imgLeft); divCardLg.appendChild(divCardLeft); divCardRight.appendChild(spanRight); divCardLg.appendChild(divCardRight); divCardLg.appendChild(aCard); document.getElementById("wafsData") .appendChild(divCardLg); createWaf(session, wafs["uniqueId"], company["uniqueId"]); } } else { hasError(wafsRequest); } }; wafsRequest.open('GET', 'https://api.shield4cloud.com/dashboard/wafs/all/' + company["uniqueId"]); wafsRequest.setRequestHeader('Content-Type', "application/json"); wafsRequest.setRequestHeader('X-Token', session); wafsRequest.send(); } function loadWaf(session, uuidCompany, uuidWaf) { const wafRequest=new XMLHttpRequest(); wafRequest.onload = () => { const status=wafRequest.status; if (status == 202) { const wafResult=JSON.parse(wafRequest.responseText); document.getElementById("wafs").style.display = "none"; document.getElementById("wafsData").style.display = "none"; document.getElementById("waf").style.display = "block"; document.getElementById("offre").value = wafResult["type"]; document.getElementById("mode").value = wafResult["mode"]; document.getElementById("hostname").value = wafResult["host"]; document.getElementById("wwwhostname").value = "www." + wafResult["host"]; document.getElementById("host").innerText = wafResult["host"]; document.getElementById("IpServerOne").value = wafResult["serverAddress"]; document.getElementById("ip").value = wafResult["serverAddress"]; document.getElementById("certificat").value = wafResult["certificat"]; document.getElementById("api").value = wafResult["apiDir"]; document.getElementById("update") .onclick = function() { updateWaf(session, uuidCompany, uuidWaf); }; } else { hasError(wafRequest); } }; wafRequest.open('GET', 'https://api.shield4cloud.com/dashboard/wafs/' + uuidWaf); wafRequest.setRequestHeader('X-Token', session); wafRequest.setRequestHeader('X-Company', uuidCompany); wafRequest.send(); } function updateWaf(session, uuidCompany, uuidWaf) { const wafRequestUpdate=new XMLHttpRequest(); wafRequestUpdate.onload = () => { const status = wafRequestUpdate.status; if (status == 202) { const wafResult = JSON.parse(wafRequestUpdate.responseText); document.getElementById("offre").value = wafResult["type"]; document.getElementById("mode").value = wafResult["mode"]; document.getElementById("hostname").value = wafResult["host"]; document.getElementById("wwwhostname").value = "www." + wafResult["host"]; document.getElementById("host").innerText = wafResult["host"]; document.getElementById("IpServerOne").value = wafResult["serverAddress"]; document.getElementById("ip").value = wafResult["serverAddress"]; document.getElementById("certificat").value = wafResult["certificat"]; window.top.window.scrollTo(0,0); alertSuccess("Votre action à bien été prise en compte."); } else { hasError(wafRequestUpdate); } }; const json = {"uniqueId": uuidWaf, "serverAddress": document.getElementById("ip").value, "certificat": document.getElementById("certificat").value, "mode": document.getElementById("modeSelect").value, "apiDir": document.getElementById("api").value}; wafRequestUpdate.open('POST', 'https://api.shield4cloud.com/dashboard/wafs/update/' + uuidWaf); wafRequestUpdate.setRequestHeader('Content-Type', "application/json"); wafRequestUpdate.setRequestHeader('X-Token', session); wafRequestUpdate.setRequestHeader('X-Company', uuidCompany); wafRequestUpdate.send(JSON.stringify(json)); }